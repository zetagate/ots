<!DOCTYPE html>
<html>
<head>
	<title>kots</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<link rel="stylesheet" type="text/css" href="dhtmlx/skins/web/dhtmlxgrid.css"/>
	<script src="dhtmlx/codebase/dhtmlxgrid.js"></script>
	<script src="jq_1_11_1.js"></script>
	<script src="db.js"></script>
	<script type="text/javascript">

		const WIDTH = 88;
		const WIDTH_AX = 40; //axis
		const HEIGHT = 30;
		const HEIGHT_AX = 40; //axis
		const MGN = 2;

		/*var reader = new FileReader();
		reader.onload = function() {
			console.log("res = " + reader.result);
		}
		reader.onerror = function(evt) {
			console.log(evt.target.error.code);
		}
		reader.readAsText(file, "UTF-8");*/

		var DAY_TIME = {"월":0, "화":100, "수":200, "목":300, "금":400, "토":500};
		var AB_TIME = {"A":0, "B":1};
		//var oParser = new DOMParser();
		//var oDOM = oParser.parseFromString(SUBJECT_XMLDATA, "text/xml");
		//var arrData = oDOM.documentElement.children;
		var xmlDoc = $.parseXML(SUBJECT_XMLDATA);
		var xmlData = xmlDoc.documentElement.children;

		var db = new Array();
		for(var i=0; i<xmlData.length; i++) {
			var subject = xmlData[i];
			var obj = {};
			for(var j=0; j<subject.children.length; j++) {
				obj[subject.children[j].tagName] = subject.children[j].innerHTML;
			}
			obj.tm = new Array();
			for(var j=0; j<16; j++) {
				var str = obj["tm"+(j+1)];
				delete obj["tm"+(j+1)];
				if(str.length<5) continue;
				var tm = 0;
				tm += DAY_TIME[str.charAt(0)];
				tm += 2*(parseInt(str.substr(2,2)-1));
				tm += AB_TIME[str.charAt(4)];
				obj.tm[j] = tm;

			}
			db[i] = obj;
		}

		xmlDoc = null;
		xmlData = null;
		subject = null;

		var canvas;
		var ctx;
		var grid1;
		var grid2;
		/*
		var lecs = [{p:0, t:"unknown", w:"mon1, mon2"},
			     {p:1, t:"자바", w:"mon1, mon2"},
		             {p:2, t:"자료구조", w:"mon1, mon2"},
		             {p:3, t:"네트워크", w:"mon1, mon2"},
		             {p:4, t:"컴파일러", w:"mon1, mon2"},
		             {p:5, t:"씨언어", w:"mon1, mon2"}];
								 */


		function addRow(grid, i)
		{
			var note = "";
			if(db[i].eng == "Y") note += "영";
			if(db[i].elr == "Y") note += "E";
			grid.addRow(i+1,[db[i].cod, db[i].ttk, db[i].cls, db[i].prf, db[i].tar
											,db[i].crd, db[i].dsg, note, db[i].cap, db[i].dep]);
		}

		function mergeNum(arr)
		{
			if(arr.length == 0) return [];
			var result = [[arr[0],1]];
			var prev = arr[0];
			for(var i=1; i<arr.length; i++) {
				if(arr[i]-prev == 1)
				++result[result.length-1][1];
				else
				result.push([arr[i], 1]);
				prev = arr[i];
			}
			return result;
		}

		function filterList()
		{
			grid1.clearAll();
			for(var i=0; i<db.length; i++) {
				if(db[i].ttk.search($("#filter")[0].value) != -1
			     || db[i].prf.search($("#filter")[0].value) != -1
			     || db[i].cod.search($("#filter")[0].value) != -1)
					addRow(grid1, i);
			}
		}

		function doOnLoad()
		{
			canvas = $("#canvas1")[0];
			ctx = canvas.getContext("2d");

			grid1 = new dhtmlXGridObject("gridbox");
			initGrid(grid1);
			//grid1.load("../common/grid.xml");
			for(var i=0; i<db.length; i++) {
				addRow(grid1, i);
			}

			grid2 = new dhtmlXGridObject("gridbox2");
			initGrid(grid2);

			grid1.attachEvent("onRowSelect", doOnRowSelect);
			grid1.attachEvent("onRowDblClicked", doOnRowDblClicked);

			$("#filter").on("input", filterList);

			setSizes();
			grid1.setSizes();
			grid2.setSizes();

			drawFrame();
		}

		function doOnRowSelect(id, ind)
		{
			//id is index+1
			//should use id-1
			var i;

			ctx.clearRect(0,0, canvas.width, canvas.height);
			drawFrame();
			drawCartList();
			drawSelection(mergeNum(db[id-1].tm), 5);

			i = id-2;
			while(i>=0) {
				if(db[i].cod == db[id-1].cod) {
					console.log(i);
					drawSelection(mergeNum(db[i].tm),2);
				}
				else break;
				--i;
			}
			i = id;
			while(i<db.length) {
				if(db[i].cod == db[id-1].cod) {
					console.log(i);
					drawSelection(mergeNum(db[i].tm),2);
				}
				else break;
				++i;
			}

		}

		function drawSelection(times, lineWidth)
		{

			ctx.beginPath();
			ctx.lineWidth = lineWidth;
			ctx.strokeStyle="#FF0000";

			var xs;
			var ys;

			if(times.length == 0) return;
			for(var i=0; i<times.length; i++) {
				var tgt = times[i][0];
				if(tgt%100<17) {
					xs = MGN + WIDTH_AX + Math.floor(tgt/100)*WIDTH;
					ys = MGN + HEIGHT_AX + (tgt%100)*HEIGHT;
					ctx.rect(xs, ys, WIDTH, HEIGHT*times[i][1]);
				}
				else {
					xs = MGN + WIDTH_AX + Math.floor(tgt/100)*WIDTH;
					ys = MGN + HEIGHT_AX + 18*HEIGHT;
					ctx.rect(xs, ys, WIDTH, HEIGHT*2);
				}
			}
			ctx.stroke();
		}

		function doOnRowDblClicked(id, ind)
		{
			//console.log(grid1.cells(id,0).getValue());
			addRow(grid2, id);
		//	var i = id;
			//grid2.addRow(lecs[i].p,[lecs[i].t,lecs[i].w]);
		}

		window.onresize = function()
		{
			setSizes();
		}

		function initGrid(grid)
		{
			grid.setImagePath("dhtmlx/skins/web/imgs/dhxgrid_web/");
			grid.setHeader("코드,과목명,분반,교수,대상,학점,설계,비고,정원,개설학부");
			grid.setInitWidths("55,130,40,60,70,40,40,40,40,100");
			grid.setColAlign("left,left,left,left,left,left,left,left,left");
			grid.setColTypes("txt,txt,txt,txt,txt,txt,txt,txt,txt,txt");
			grid.setColSorting("str,str,str,str,str,str,str,str,str,str");
			grid.setEditable(false);
			dhtmlxEvent(window, "resize", function () {grid.setSizes();});
			grid.init();
		}

		function setSizes()
		{
			var docuWidth = $(document).width();
			$(wrapper).width(docuWidth-(canvas.width+20));
		}

		function drawFrame()
		{
			var timeName = ["01A","01B","02A","02B","03A","03B","04A","04B","05A","05B","06A","06B","07A","07B","08A","08B","09A","09B"];
			var weekName = ["월요일", "화요일", "수요일", "목요일", "금요일", "토요일"];
			var xs;
			var ys;
			ctx.beginPath();

			ctx.lineWidth = 1;
			ctx.strokeStyle="#000000";
			ctx.fillStyle="#000000";
			ctx.font="13px dotum";
			ctx.rect(MGN, MGN, ctx.width-MGN*2, ctx.height-MGN*2);


			ctx.rect(MGN, MGN, WIDTH_AX, HEIGHT_AX);
			for(var i=0; i<18; i++) {
				xs = MGN;
				ys = MGN+i*HEIGHT+HEIGHT_AX;
				ctx.rect(xs, ys, WIDTH_AX, HEIGHT);
				ctx.fillText(timeName[i],xs+8,ys+18);
			}
			ctx.rect(xs, ys+HEIGHT, WIDTH_AX, HEIGHT*2);
			ctx.fillText("이후",xs+7,ys+HEIGHT+30);

			ctx.lineWidth=0.7;
			for(var j=0; j<weekName.length; j++) {
				ctx.rect(MGN+j*WIDTH+WIDTH_AX, MGN, WIDTH, HEIGHT_AX);
				ctx.fillText(weekName[j],MGN+j*WIDTH+WIDTH_AX+25,MGN+25);
				for(var i=0; i<18; i++) {
					xs = MGN+j*WIDTH+WIDTH_AX;
					ys = MGN+i*HEIGHT+HEIGHT_AX;
					ctx.rect(xs, ys, WIDTH, HEIGHT);
				}
				ctx.rect(xs, ys+HEIGHT, WIDTH, HEIGHT*2);
			}



			//ctx.fillStyle="#9CC99C";
			//ctx.fillRect(130, 222, WIDTH, HEIGHT);

			ctx.stroke();

		}

		function drawCartList()
		{
		}


	</script>
</head>
<body onload="doOnLoad()">
	<!--<input type = "file" id="file"/>-->
	<h1>test</h1>

	<div id="wrapper" style="float:left;width:auto;height:600px;">
		<input type="text" id="filter" placeholder="ㅗㅗㅗ">
		<div id="gridbox" style="width:100%;height:370px;background-color:white;"></div>
		<br />
		<div id="gridbox2" style="width:100%;height:170px;background-color:white;"></div>
	</div>

	<canvas id="canvas1" width=572, height=645, style="float:right;border:1px solid #000000"></canvas>
	<script type="text/javascript">

	</script>
	<br />
	<br />

	<br />

	<br />
</body>
</html>
